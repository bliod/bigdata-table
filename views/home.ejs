<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Home</title>
  </head>
  <style>
    table,
    th,
    td {
      border: 1px solid black;
      border-collapse: collapse;
    }
    .active {
      background-color: lightblue;
    }
  </style>
  <body>
    <h1>The Table</h1>
    <h5>Last selected value :</h5>
    <p><button onclick="sortTable(1)">Sort name</button></p>
    <p><button onclick="sortTable(2)">Sort age</button></p>
    <p><button onclick="sortTable(3)">Sort balance</button></p>
    <p><button onclick="sortTable(0)">Sort id</button></p>
    <div>
      <div>
        <button id="backwards"><<</button>
        <button id="prev">prev</button>
        <div class="pagenumbers" id="pagination"></div>
        <button id="next">next</button>
        <button id="forwards">>></button>
      </div>

      <table id="table" style="width: 100%"></table>
    </div>
  </body>

  <script type="text/javascript">
    const data = <%-JSON.stringify(json)%>;
    const list_element = document.getElementById("table");
    const pagination_element = document.getElementById("pagination");

    let current_page = 1;
    let rows = 20;

    function DisplayList(items, wrapper, rows_per_page, page) {
      wrapper.innerHTML = "";
      page--;

      let start = rows_per_page * page;
      let end = start + rows_per_page;
      let paginatedItems = items.slice(start, end);

      // console.log(paginatedItems, "paginatedItems");
      let column = document.createElement("tr");

      let columnId = document.createElement("th");
      columnId.innerText = "ID";
      let columnName = document.createElement("th");
      columnName.innerText = "Name";
      let columnAge = document.createElement("th");
      columnAge.innerText = "Age";
      let columnBalance = document.createElement("th");
      columnBalance.innerText = "Balance";

      column.append(columnId, columnName, columnAge, columnBalance);
      wrapper.appendChild(column);

      for (let i = 0; i < paginatedItems.length; i++) {
        let item_element = document.createElement("tr");
        let thName = document.createElement("td");
        let thId = document.createElement("td");
        let thAge = document.createElement("td");
        let thBalance = document.createElement("td");

        thName.innerText = paginatedItems[i].name;
        thId.innerText = paginatedItems[i]._id;
        thAge.innerText = paginatedItems[i].age;
        thBalance.innerText = paginatedItems[i].balance;

        item_element.append(thId, thName, thAge, thBalance);
        wrapper.appendChild(item_element);
      }
    }

    function SetupPagination(items, wrapper, rows_per_page) {
      let backwards = document.getElementById("backwards");
      let forwards = document.getElementById("forwards");
      let prev = document.getElementById("prev");
      let next = document.getElementById("next");
      let btnCount = 1;

      let page_count = Math.ceil(items.length / rows_per_page);

      prev.addEventListener("click", () => {
        //update class button
        if (current_page > 1) {
          let removeCurrent = document.getElementById(`btn${current_page}`);
          removeCurrent.classList.remove("active");

          current_page -= 1;
          DisplayList(items, list_element, rows, current_page);

          console.log(current_page, btnCount);
          if (current_page < btnCount) {
            btnCount -= 10;
            wrapper.innerHTML = "";
            if (btnCount < 0) {
              btnCount = 1;
            }
            for (let i = btnCount; i < btnCount + 10; i++) {
              let btn = PaginationButton(i, items);
              wrapper.appendChild(btn);
            }
          }
          let addPrev = document.getElementById(`btn${current_page}`);
          addPrev.classList.add("active");
        }
      });

      next.addEventListener("click", () => {
        if (current_page < page_count) {
          let removeCurrent = document.getElementById(`btn${current_page}`);
          removeCurrent.classList.remove("active");

          current_page += 1;
          DisplayList(items, list_element, rows, current_page);

          if (current_page > btnCount + 9) {
            btnCount += 10;
            wrapper.innerHTML = "";
            for (let i = btnCount; i < btnCount + 10; i++) {
              if (i <= page_count) {
                //Append only till page count
                let btn = PaginationButton(i, items);
                wrapper.appendChild(btn);
              }
            }
          }

          let addNext = document.getElementById(`btn${current_page}`);
          addNext.classList.add("active");
        }
      });

      forwards.addEventListener("click", () => {
        // console.log(btnCount,'btnCount')
        if (btnCount + 10 > page_count) {
          //Dont add more that available page count
          return;
        }
        btnCount += 10;
        wrapper.innerHTML = "";
        for (let i = btnCount; i < btnCount + 10; i++) {
          if (i <= page_count) {
            //Append only till page count
            let btn = PaginationButton(i, items);
            wrapper.appendChild(btn);
          }
        }
      });
      backwards.addEventListener("click", () => {
        btnCount -= 10;
        wrapper.innerHTML = "";
        if (btnCount < 0) {
          btnCount = 1;
        }
        for (let i = btnCount; i < btnCount + 10; i++) {
          let btn = PaginationButton(i, items);
          wrapper.appendChild(btn);
        }
      });
      for (let i = btnCount; i < btnCount + 10; i++) {
        let btn = PaginationButton(i, items);

        wrapper.appendChild(btn);
      }
    }

    function PaginationButton(page, items) {
      let button = document.createElement("button");

      button.innerText = page;
      button.id = `btn${page}`;

      if (current_page == page) button.classList.add("active");

      button.addEventListener("click", function () {
        current_page = page;
        DisplayList(items, list_element, rows, current_page);

        let current_btn = document.querySelector(".pagenumbers button.active");
        current_btn.classList.remove("active");

        button.classList.add("active");
      });

      return button;
    }

    DisplayList(data, list_element, rows, current_page);
    SetupPagination(data, pagination_element, rows);
  </script>
  <script>
    function sortTable(column) {
      let table, rows, switching, i, x, y, shouldSwitch;
      table = document.getElementById("table");
      switching = true;
      console.log("sort");
      /*Make a loop that will continue until
      no switching has been done:*/
      while (switching) {
        //start by saying: no switching is done:
        switching = false;
        rows = table.rows;
        /*Loop through all table rows (except the
        first, which contains table headers):*/
        for (i = 1; i < rows.length - 1; i++) {
          //start by saying there should be no switching:
          shouldSwitch = false;
          /*Get the two elements you want to compare,
          one from current row and one from the next:*/
          x = rows[i].getElementsByTagName("TD")[column];
          y = rows[i + 1].getElementsByTagName("TD")[column];
          //check if the two rows should switch place:
          if (column === 0 || column === 2) {
            if (parseInt(x.innerHTML) > parseInt(y.innerHTML)) {
              //if so, mark as a switch and break the loop:
              shouldSwitch = true;
              break;
            }
          } else {
            if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
              //if so, mark as a switch and break the loop:
              shouldSwitch = true;
              break;
            }
          }
        }
        if (shouldSwitch) {
          /*If a switch has been marked, make the switch
          and mark that a switch has been done:*/
          rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
          switching = true;
        }
      }
    }
  </script>
</html>
